---
name: Check Harbor version

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * 1"

jobs:
  check-version:
    name: Check for new Harbor release
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Get latest Harbor release
        id: harbor_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_VERSION=$(gh api repos/goharbor/harbor/releases/latest --jq '.tag_name' | sed 's/^v//')
          echo "latest_version=${LATEST_VERSION}" >> "$GITHUB_OUTPUT"

          CURRENT_VERSION=$(grep '^harbor_version_release:' defaults/main.yml | awk '{print $2}')
          echo "current_version=${CURRENT_VERSION}" >> "$GITHUB_OUTPUT"

          if [ "${LATEST_VERSION}" != "${CURRENT_VERSION}" ]; then
            echo "update_needed=true" >> "$GITHUB_OUTPUT"
          else
            echo "update_needed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Update defaults/main.yml
        if: steps.harbor_release.outputs.update_needed == 'true'
        env:
          LATEST_VERSION: ${{ steps.harbor_release.outputs.latest_version }}
        run: |
          sed -i "s/^harbor_version_release:.*/harbor_version_release: ${LATEST_VERSION}/" defaults/main.yml

      - name: Create Pull Request
        if: steps.harbor_release.outputs.update_needed == 'true'
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0  # v8.1.0
        with:
          token: ${{ secrets.PAT_GITHUB }}
          commit-message: "chore(deps): bump harbor from ${{ steps.harbor_release.outputs.current_version }} to ${{ steps.harbor_release.outputs.latest_version }}"
          title: "chore(deps): bump harbor from ${{ steps.harbor_release.outputs.current_version }} to ${{ steps.harbor_release.outputs.latest_version }}"
          body: |
            Automated Harbor version bump.

            - **Current version**: ${{ steps.harbor_release.outputs.current_version }}
            - **New version**: ${{ steps.harbor_release.outputs.latest_version }}
            - **Release**: https://github.com/goharbor/harbor/releases/tag/v${{ steps.harbor_release.outputs.latest_version }}
          branch: "chore/harbor-${{ steps.harbor_release.outputs.latest_version }}"
          labels: enhancement,dependency-management
          assignees: ialejandro
